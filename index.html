<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Nostre Diari de Moments</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 350px; border-radius: 1.5rem; z-index: 1; }
        .heart-bg { background-color: #fff5f5; }
        .custom-popup .leaflet-popup-content-wrapper { border-radius: 1rem; padding: 5px; }
    </style>
</head>
<body class="heart-bg font-sans mb-10">

    <header class="p-8 text-center">
        <h1 class="text-4xl font-bold text-red-500 drop-shadow-sm">‚ù§Ô∏è Els Nostres Moments</h1>
        <p class="text-gray-500 mt-2 italic">Apropa la targeta i guarda un record per sempre</p>
    </header>

    <main class="max-w-md mx-auto p-4 space-y-6">

        <section class="bg-white p-6 rounded-3xl shadow-xl border border-red-50">
            <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center gap-2">
                <span>üì∏</span> Nou Moment Especial
            </h2>
            
            <div class="space-y-4">
                <div class="flex flex-col items-center justify-center border-2 border-dashed border-red-200 rounded-2xl p-6 hover:bg-red-50 transition-all cursor-pointer group" onclick="document.getElementById('photo-input').click()">
                    <div class="text-4xl group-hover:scale-110 transition-transform">üì∑</div>
                    <span class="text-sm text-gray-400 mt-2" id="photo-status">Prem per fer la foto</span>
                    <input type="file" id="photo-input" accept="image/*" capture="environment" class="hidden">
                </div>

                <input type="text" id="moment-title" placeholder="Quin moment estem vivint?" 
                    class="w-full p-4 rounded-xl bg-gray-50 border-none focus:ring-2 focus:ring-red-400 text-gray-700 shadow-inner">

                <button onclick="saveMoment()" id="save-btn"
                    class="w-full bg-gradient-to-r from-red-400 to-red-500 text-white font-bold py-4 rounded-2xl shadow-lg hover:from-red-500 hover:to-red-600 transition-all active:scale-95 flex justify-center items-center gap-2">
                    <span>‚ú®</span> Guardar al Mapa
                </button>
            </div>
        </section>

        <section class="bg-white p-2 rounded-[2rem] shadow-xl border border-red-50 overflow-hidden">
            <div id="map"></div>
        </section>

    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // La teva configuraci√≥ de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDWxiQ90XKEfhW9vMuEDBTuDWeiIKp_9Ys",
            authDomain: "irene-99a19.firebaseapp.com",
            projectId: "irene-99a19",
            storageBucket: "irene-99a19.firebasestorage.app",
            messagingSenderId: "175449192892",
            appId: "1:175449192892:web:515710aa338243623513b9"
        };

        // Inicialitzar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- L√íGICA DEL MAPA (Leaflet) ---
        const map = L.map('map').setView([41.3851, 2.1734], 13); // Barcelona per defecte
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap'
        }).addTo(map);

        // Carregar moments de la base de dades i posar-los al mapa
        async function loadMoments() {
            const q = query(collection(db, "moments"), orderBy("date", "desc"));
            const querySnapshot = await getDocs(q);
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const dateStr = new Date(data.date).toLocaleDateString('ca-ES', { day: 'numeric', month: 'long' });
                
                L.marker([data.lat, data.lon]).addTo(map)
                    .bindPopup(`
                        <div class="text-center">
                            <img src="${data.imageUrl}" class="rounded-lg mb-2 w-full object-cover h-24">
                            <b class="text-red-500">${data.title}</b><br>
                            <small class="text-gray-400">${dateStr}</small>
                        </div>
                    `, { className: 'custom-popup' });
            });
        }
        loadMoments();

        // Actualitzar text quan es selecciona una foto
        document.getElementById('photo-input').addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                document.getElementById('photo-status').innerText = "üì∏ Foto seleccionada!";
                document.getElementById('photo-status').classList.add('text-green-500');
            }
        });

        // --- L√íGICA PER GUARDAR ---
        window.saveMoment = async function() {
            const titleInput = document.getElementById('moment-title');
            const fileInput = document.getElementById('photo-input');
            const btn = document.getElementById('save-btn');

            if (!titleInput.value || !fileInput.files[0]) {
                alert("Si us plau, posa un t√≠tol i fes una foto!");
                return;
            }

            btn.innerText = "üöÄ Guardant m√†gia...";
            btn.disabled = true;

            // 1. Obtenir GPS
            navigator.geolocation.getCurrentPosition(async (position) => {
                const { latitude, longitude } = position.coords;

                try {
                    // 2. Pujar Foto a Storage
                    const file = fileInput.files[0];
                    const storageRef = ref(storage, `moments/${Date.now()}_${file.name}`);
                    const snapshot = await uploadBytes(storageRef, file);
                    const downloadURL = await getDownloadURL(snapshot.ref);

                    // 3. Guardar dades a Firestore
                    await addDoc(collection(db, "moments"), {
                        title: titleInput.value,
                        imageUrl: downloadURL,
                        lat: latitude,
                        lon: longitude,
                        date: new Date().toISOString()
                    });

                    // √àxit
                    alert("Moment guardat per sempre! ‚ù§Ô∏è");
                    location.reload(); 

                } catch (error) {
                    console.error(error);
                    alert("Error guardant el moment. Revisa els permisos.");
                    btn.disabled = false;
                    btn.innerText = "Guardar Moment ‚ú®";
                }
            }, () => {
                alert("Heu d'activar el GPS per guardar el moment!");
                btn.disabled = false;
                btn.innerText = "Guardar Moment ‚ú®";
            }, { enableHighAccuracy: true });
        };
    </script>
</body>
</html>
