<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Nostre Diari de Moments</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 350px; width: 100%; border-radius: 1.5rem; z-index: 1; border: 2px solid #fee2e2; }
        .heart-bg { background-color: #fff5f5; }
    </style>
</head>
<body class="heart-bg font-sans mb-10">

    <header class="p-8 text-center">
        <h1 class="text-4xl font-bold text-red-500">‚ù§Ô∏è Els Nostres Moments</h1>
        <p class="text-gray-500 mt-2 italic">Captura la m√†gia de la nostra hist√≤ria</p>
    </header>

    <main class="max-w-md mx-auto p-4 space-y-6">

        <section class="bg-white p-6 rounded-3xl shadow-xl border border-red-50">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">üì∏ Nou Record</h2>
            <div class="space-y-4">
                <div class="flex flex-col items-center justify-center border-2 border-dashed border-red-200 rounded-2xl p-6 hover:bg-red-50 cursor-pointer" onclick="document.getElementById('photo-input').click()">
                    <div class="text-4xl" id="camera-icon">üì∑</div>
                    <span class="text-sm text-gray-400 mt-2" id="photo-status">Prem per fer la foto</span>
                    <input type="file" id="photo-input" accept="image/*" capture="environment" class="hidden">
                </div>

                <input type="text" id="moment-title" placeholder="Quin moment estem vivint?" 
                    class="w-full p-4 rounded-xl bg-gray-50 border-none focus:ring-2 focus:ring-red-400 shadow-inner">

                <button onclick="saveMoment()" id="save-btn"
                    class="w-full bg-red-500 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-all">
                    Guardar Moment ‚ú®
                </button>
            </div>
        </section>

        <section class="bg-white p-2 rounded-[2rem] shadow-xl overflow-hidden">
            <div id="map"></div>
        </section>

    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDWxiQ90XKEfhW9vMuEDBTuDWeiIKp_9Ys",
            authDomain: "irene-99a19.firebaseapp.com",
            projectId: "irene-99a19",
            storageBucket: "irene-99a19.firebasestorage.app",
            messagingSenderId: "175449192892",
            appId: "1:175449192892:web:515710aa338243623513b9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Inicialitzaci√≥ segura del Mapa
        const map = L.map('map').setView([41.3851, 2.1734], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // Carregar moments
        async function loadMoments() {
            try {
                const q = query(collection(db, "moments"), orderBy("date", "desc"));
                const querySnapshot = await getDocs(q);
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    L.marker([data.lat, data.lon]).addTo(map)
                        .bindPopup(`<img src="${data.imageUrl}" width="100"><br><b>${data.title}</b>`);
                });
            } catch (e) { console.error("Error carregant:", e); }
        }
        loadMoments();

        // Funci√≥ Guardar
        window.saveMoment = async function() {
            const title = document.getElementById('moment-title').value;
            const file = document.getElementById('photo-input').files[0];
            const btn = document.getElementById('save-btn');

            if (!title || !file) {
                alert("Fes la foto i posa un t√≠tol!");
                return;
            }

            btn.disabled = true;
            btn.innerText = "Guardant...";

            navigator.geolocation.getCurrentPosition(async (pos) => {
                try {
                    // 1. Pujar foto
                    const storageRef = ref(storage, `moments/${Date.now()}_${file.name}`);
                    const snapshot = await uploadBytes(storageRef, file);
                    const url = await getDownloadURL(snapshot.ref);

                    // 2. Guardar a la base de dades
                    await addDoc(collection(db, "moments"), {
                        title: title,
                        imageUrl: url,
                        lat: pos.coords.latitude,
                        lon: pos.coords.longitude,
                        date: new Date().toISOString()
                    });

                    alert("Fet! ‚ù§Ô∏è");
                    location.reload();
                } catch (e) {
                    alert("Error! Revisa les 'Rules' de Firebase.");
                    console.error(e);
                    btn.disabled = false;
                }
            }, (err) => {
                alert("Activa el GPS!");
                btn.disabled = false;
            }, { enableHighAccuracy: true });
        };

        document.getElementById('photo-input').onchange = (e) => {
            if(e.target.files[0]) {
                document.getElementById('photo-status').innerText = "‚úÖ Foto llesta!";
                document.getElementById('camera-icon').innerText = "üì∏";
            }
        };
    </script>
</body>
</html>
